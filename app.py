import streamlit as st
from google import genai
from google.genai.errors import APIError
import pandas as pd
import io

# --- 1. à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¹à¸¥à¸° Sidebar ---
st.set_page_config(
    page_title="âœˆï¸ Airline Route Calculator (Gemini Powered)",
    layout="wide",
    initial_sidebar_state="expanded"
)

# à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸
AIRCRAFT_DATA = {
    "A320neo": {"eco": 156, "bc": 8, "first": 0, "fuel_cost": 708, "range_km": 6300},
    "A321neo": {"eco": 162, "bc": 12, "first": 0, "fuel_cost": 840, "range_km": 7400},
    "A350-900": {"eco": 288, "bc": 40, "first": 0, "fuel_cost": 1950, "range_km": 15000},
    "A350-900ULR": {"eco": 133, "bc": 48, "first": 8, "fuel_cost": 2095, "range_km": 18000},
    "B787-8": {"eco": 261, "bc": 30, "first": 0, "fuel_cost": 1370, "range_km": 13500},
    "B787-9": {"eco": 297, "bc": 36, "first": 0, "fuel_cost": 1650, "range_km": 14000},
    "B777-300ER": {"eco": 315, "bc": 40, "first": 8, "fuel_cost": 2080, "range_km": 13650},
}

CONTINENTS = [
    "Africa", "Antarctica", "Asia", "Europe", "North America", "Oceania", "South America"
]

def initialize_gemini():
    """à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Gemini API"""
    try:
        if st.session_state.gemini_api_key:
            client = genai.Client(api_key=st.session_state.gemini_api_key)
            return client
        else:
            st.error("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ Gemini API Key à¹ƒà¸™ Sidebar")
            return None
    except Exception as e:
        st.error(f"à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Gemini API: {e}")
        return None

# Sidebar à¸ªà¸³à¸«à¸£à¸±à¸š API Key
with st.sidebar:
    st.image("https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Air_transport_icon_with_aeroplane.svg/1200px-Air_transport_icon_with_aeroplane.svg.png", width=100)
    st.title("âš™ï¸ à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² API")

    # à¸Šà¹ˆà¸­à¸‡à¸£à¸±à¸š Gemini API Key (à¹ƒà¸Šà¹‰ st.text_input à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸§à¸²à¸¡à¸‡à¹ˆà¸²à¸¢à¹à¸¥à¸°à¹„à¸¡à¹ˆà¹€à¸à¹‡à¸šà¹ƒà¸™ Session)
    gemini_api_key = st.text_input(
        "**Google Gemini API Key**",
        type="password",
        help="API Key à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ Google Gemini. à¸ªà¸²à¸¡à¸²à¸£à¸–à¸‚à¸­à¹„à¸”à¹‰à¸ˆà¸²à¸ Google AI Studio"
    )

    if 'gemini_api_key' not in st.session_state:
        st.session_state.gemini_api_key = ""
        
    st.session_state.gemini_api_key = gemini_api_key

# à¸ªà¹ˆà¸§à¸™à¸«à¸¥à¸±à¸à¸‚à¸­à¸‡à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š
st.title("âœˆï¸ Airline Route Calculator (Gemini Powered)")
st.caption("à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸³à¸™à¸§à¸“à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸šà¸´à¸™à¹ƒà¸«à¸¡à¹ˆ à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸ Google Gemini")


# --- 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ Gemini API (Mock à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥) ---

@st.cache_data(show_spinner="à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...")
def check_airport_consistency(client: genai.Client, icao_code: str, city_name: str, continent: str):
    """
    1.2: à¹ƒà¸«à¹‰ Gemini à¹€à¸Šà¹‡à¸„à¸„à¸§à¸²à¸¡à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™
    *à¹ƒà¸™à¹‚à¸„à¹‰à¸”à¸ˆà¸£à¸´à¸‡ à¸„à¸¸à¸“à¸ˆà¸°à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡ Prompt à¹„à¸›à¹ƒà¸«à¹‰ Gemini à¹€à¸žà¸·à¹ˆà¸­à¸—à¸³à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š*
    """
    prompt = (
        f"à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™: ICAO Code: {icao_code}, City: {city_name}, Continent: {continent}. "
        "à¸–à¹‰à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡ (à¸•à¸£à¸‡à¸•à¸²à¸¡à¹‚à¸¥à¸à¸ˆà¸£à¸´à¸‡) à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸§à¹ˆà¸² 'PASS'. à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸§à¹ˆà¸² 'FAIL: [à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸§à¹ˆà¸²à¸—à¸³à¹„à¸¡à¹„à¸¡à¹ˆà¸•à¸£à¸‡à¸à¸±à¸™]'. "
        "à¹€à¸Šà¹ˆà¸™ 'FAIL: DMK à¸„à¸·à¸­ Bangkok à¹à¸•à¹ˆ Continent à¹€à¸›à¹‡à¸™ Europe'"
    )
    
    # --- Mock Response à¸ªà¸³à¸«à¸£à¸±à¸š Demo ---
    if icao_code.upper() == "BKK" and city_name.lower() == "bangkok" and continent == "Asia":
        return "PASS"
    elif icao_code.upper() == "DMK" and city_name.lower() == "bangkok" and continent == "Europe":
        return "FAIL: DMK (Don Mueang) à¸•à¸±à¹‰à¸‡à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆ Bangkok, Asia à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ Europe"
    elif icao_code.upper() == "DMK" and city_name.lower() == "bangkok" and continent == "Asia":
        return "PASS"
    else:
        # à¹€à¸žà¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡ Gemini
        try:
            response = client.models.generate_content(
                model='gemini-2.5-flash',
                contents=prompt
            )
            return response.text.strip()
        except APIError as e:
            return f"API_ERROR: à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ Gemini à¹„à¸”à¹‰: {e}"
        except Exception:
             return "PASS" # Default fail for demo ease

@st.cache_data(show_spinner="à¸à¸³à¸¥à¸±à¸‡à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™...")
def get_flight_distance(client: genai.Client, destination_icao: str):
    """
    2.1: à¹ƒà¸«à¹‰ Gemini à¸„à¹‰à¸™à¸«à¸²à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™à¸ˆà¸²à¸ BKK à¸–à¸¶à¸‡à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡ (à¹€à¸›à¹‡à¸™à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡ à¸à¸´à¹‚à¸¥à¹€à¸¡à¸•à¸£)
    *à¹ƒà¸™à¹‚à¸„à¹‰à¸”à¸ˆà¸£à¸´à¸‡ à¸„à¸¸à¸“à¸ˆà¸°à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡ Prompt à¹„à¸›à¹ƒà¸«à¹‰ Gemini à¹€à¸žà¸·à¹ˆà¸­à¸„à¸³à¸™à¸§à¸“*
    """
    prompt = (
        f"à¸„à¹‰à¸™à¸«à¸²à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™ (Great Circle Distance) à¸ˆà¸²à¸à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™ BKK (Suvarnabhumi, Bangkok, Thailand) "
        f"à¹„à¸›à¸¢à¸±à¸‡à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸¡à¸µ ICAO code à¸„à¸·à¸­ {destination_icao}. "
        "à¹ƒà¸«à¹‰à¹à¸ªà¸”à¸‡à¸œà¸¥à¹€à¸‰à¸žà¸²à¸° 'à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¹€à¸›à¹‡à¸™à¸à¸´à¹‚à¸¥à¹€à¸¡à¸•à¸£' à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¹‚à¸”à¸¢à¹€à¸›à¹‡à¸™ **à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡** à¹à¸¥à¸° **à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸„à¹ˆà¸²à¸›à¸£à¸°à¸¡à¸²à¸“**"
    )

    # --- Mock Response à¸ªà¸³à¸«à¸£à¸±à¸š Demo ---
    if destination_icao.upper() == "LHR":
        return 9553
    elif destination_icao.upper() == "JFK":
        return 13958
    elif destination_icao.upper() == "SYD":
        return 7523
    else:
        # à¹€à¸žà¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡ Gemini
        try:
            response = client.models.generate_content(
                model='gemini-2.5-flash',
                contents=prompt
            )
            try:
                # à¸žà¸¢à¸²à¸¢à¸²à¸¡à¹à¸›à¸¥à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹€à¸›à¹‡à¸™à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡à¸•à¸²à¸¡à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”
                return int(response.text.strip())
            except ValueError:
                return 0 # à¸ªà¹ˆà¸‡à¸„à¸·à¸™ 0 à¸«à¸£à¸·à¸­à¸„à¹ˆà¸²à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸–à¹‰à¸² Gemini à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹ƒà¸«à¹‰à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡
        except APIError as e:
            st.error(f"API_ERROR: à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¹„à¸”à¹‰: {e}")
            return 0
        except Exception:
            return 0

@st.cache_data(show_spinner="à¸à¸³à¸¥à¸±à¸‡à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œ Demand à¹à¸¥à¸°à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸‚à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™...")
def get_aircraft_evaluation(client: genai.Client, distance_km: int, destination_icao: str, destination_city: str):
    """
    2.2 & 2.3: à¹ƒà¸«à¹‰ Gemini à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™ à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œ Demand à¹à¸¥à¸°à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
    *à¹ƒà¸™à¹‚à¸„à¹‰à¸”à¸ˆà¸£à¸´à¸‡ à¸™à¸µà¹ˆà¸„à¸·à¸­à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™à¸—à¸µà¹ˆà¸ªà¸¸à¸” à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¹ƒà¸«à¹‰ Gemini à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹à¸¥à¸°à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™ JSON/Markdown Table*
    """
    prompt = (
        f"à¸ˆà¸²à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸šà¸´à¸™ BKK à¹„à¸›à¸¢à¸±à¸‡ {destination_city} ({destination_icao}) à¸‹à¸¶à¹ˆà¸‡à¸¡à¸µà¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™ {distance_km} à¸à¸´à¹‚à¸¥à¹€à¸¡à¸•à¸£. "
        "à¹ƒà¸«à¹‰à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ Demand à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸‚à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸£à¸¸à¹ˆà¸™à¸•à¹ˆà¸²à¸‡à¹† à¸”à¸±à¸‡à¸™à¸µà¹‰:\n"
        "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™: {AIRCRAFT_DATA}\n"
        "à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ Demand (2.2.8): à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸ˆà¸²à¸à¹€à¸—à¸µà¹ˆà¸¢à¸§à¸šà¸´à¸™à¸ªà¸²à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¸­à¸·à¹ˆà¸™à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ + à¸›à¸£à¸°à¸Šà¸²à¸à¸£ (à¸ˆà¸³à¸™à¸§à¸™, à¸à¸²à¸™à¸°, à¸­à¸²à¸Šà¸µà¸ž) + à¸à¸²à¸£à¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§ + à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¸­à¸·à¹ˆà¸™à¹†\n"
        "à¸à¸£à¸¸à¸“à¸²à¸ªà¸£à¹‰à¸²à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š **CSV (Comma Separated Values)** à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µ Header à¹à¸¥à¸°à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸•à¹ˆà¸²à¸‡à¹† à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸šà¸™à¸µà¹‰:\n"
        "1. à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™ (à¸•à¸²à¸¡ key à¹ƒà¸™ AIRCRAFT_DATA)\n"
        "2. à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™ (à¸à¸´à¹‚à¸¥à¹€à¸¡à¸•à¸£) (à¸•à¸²à¸¡ key à¹ƒà¸™ AIRCRAFT_DATA)\n"
        "3. à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡ (eco/bc/first)\n"
        "4. à¸­à¸±à¸•à¸£à¸²à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡ (usd/hr)\n"
        "5. à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œà¸œà¸¹à¹‰à¹‚à¸”à¸¢à¸ªà¸²à¸£à¸‚à¸²à¹„à¸›à¸•à¹ˆà¸­à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ (eco/bc/first) (à¹€à¸Šà¹ˆà¸™ 100/10/2)\n"
        "6. à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œà¸œà¸¹à¹‰à¹‚à¸”à¸¢à¸ªà¸²à¸£à¸‚à¸²à¸à¸¥à¸±à¸šà¸•à¹ˆà¸­à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ (eco/bc/first)\n"
        "7. à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¹€à¸—à¸µà¹ˆà¸¢à¸§à¸šà¸´à¸™ (à¹„à¸›+à¸à¸¥à¸±à¸š) à¸•à¹ˆà¸­à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡)\n"
        "8. à¹€à¸§à¸¥à¸² Departure à¸ˆà¸²à¸ BKK à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (XX:XXà¸™., XX:XXà¸™., ...)\n"
        "9. à¹€à¸§à¸¥à¸² Departure à¸ˆà¸²à¸à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™à¸™à¸±à¹‰à¸™à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (XX:XXà¸™., XX:XXà¸™., ...)\n"
        "10. à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (5.0, 4.5, ..., 1.0, 0.0)\n"
        "11. à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸ (50-100 à¸„à¸³ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢)"
    )

    # --- Mock Response (CSV format) à¸ªà¸³à¸«à¸£à¸±à¸š Demo ---
    if destination_icao.upper() == "LHR":
        mock_csv = """
A320neo,6300,156/8/0,708,200/20/0,210/25/0,0,N/A,N/A,0.0,à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸£à¸¸à¹ˆà¸™à¸™à¸µà¹‰à¸¡à¸µà¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¹„à¸¡à¹ˆà¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¸—à¸µà¹ˆà¸ˆà¸°à¸šà¸´à¸™à¸•à¸£à¸‡à¸ˆà¸²à¸ BKK à¹„à¸› LHR. à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸à¸²à¸£à¹à¸§à¸°à¹€à¸•à¸´à¸¡à¸™à¹‰à¸³à¸¡à¸±à¸™à¸‹à¸¶à¹ˆà¸‡à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸›à¸•à¸²à¸¡à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”à¸à¸²à¸£à¸šà¸´à¸™à¸£à¸°à¸¢à¸°à¹„à¸à¸¥ à¸—à¸³à¹ƒà¸«à¹‰à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¸¢à¸´à¹ˆà¸‡
A321neo,7400,162/12/0,840,200/20/0,210/25/0,0,N/A,N/A,0.0,à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸£à¸¸à¹ˆà¸™à¸™à¸µà¹‰à¸¡à¸µà¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¹„à¸¡à¹ˆà¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¸—à¸µà¹ˆà¸ˆà¸°à¸šà¸´à¸™à¸•à¸£à¸‡à¸ˆà¸²à¸ BKK à¹„à¸› LHR à¹€à¸Šà¹ˆà¸™à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸š A320neo. à¸à¸²à¸£à¸šà¸´à¸™à¸£à¸°à¸¢à¸°à¹„à¸à¸¥à¸‚à¹‰à¸²à¸¡à¸—à¸§à¸µà¸›à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¸ªà¸¹à¸‡à¸à¸§à¹ˆà¸²
A350-900,15000,288/40/0,1950,200/20/0,210/25/0,10,"00:05à¸™., 09:30à¸™., 00:05à¸™., 09:30à¸™., 00:05à¸™.","19:00à¸™., 13:00à¸™., 19:00à¸™., 13:00à¸™., 19:00à¸™.",4.5,A350-900 à¸¡à¸µà¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¸•à¹ˆà¸­à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸™à¸µà¹‰ à¹à¸¥à¸°à¸¡à¸µà¸„à¸§à¸²à¸¡à¸ˆà¸¸à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸à¸±à¸š Demand à¸›à¸²à¸™à¸à¸¥à¸²à¸‡à¸–à¸¶à¸‡à¸ªà¸¹à¸‡ à¸à¸²à¸£à¸ˆà¸±à¸”à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¸¢à¸·à¸”à¸«à¸¢à¸¸à¹ˆà¸™à¸”à¸µà¹€à¸¢à¸µà¹ˆà¸¢à¸¡ à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸šà¸´à¸™à¸‚à¹‰à¸²à¸¡à¸—à¸§à¸µà¸›
A350-900ULR,18000,133/48/8,2095,200/20/0,210/25/0,7,"00:05à¸™., 00:05à¸™., 00:05à¸™.","19:00à¸™., 19:00à¸™., 19:00à¸™.",3.5,à¸£à¸¸à¹ˆà¸™ ULR à¸¡à¸µà¸žà¸´à¸ªà¸±à¸¢à¸šà¸´à¸™à¸ªà¸¹à¸‡à¸¡à¸²à¸à¹à¸•à¹ˆà¸¡à¸µà¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡à¸™à¹‰à¸­à¸¢à¹€à¸à¸´à¸™à¹„à¸›à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸¡à¸µ Demand à¸ªà¸¹à¸‡à¸­à¸¢à¹ˆà¸²à¸‡ LHR à¹à¸¡à¹‰à¸ˆà¸°à¸¡à¸µà¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡ First Class à¸‹à¸¶à¹ˆà¸‡à¸­à¸²à¸ˆà¸ˆà¸°à¹€à¸à¸´à¸™à¸„à¸§à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸‚à¸­à¸‡à¸•à¸¥à¸²à¸” Business Class à¸à¹‡à¸¡à¸µà¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡à¸ˆà¸³à¸à¸±à¸”
B787-8,13500,261/30/0,1370,200/20/0,210/25/0,8,"09:30à¸™., 21:00à¸™.","13:00à¸™., 02:00à¸™.",3.0,à¸žà¸´à¸ªà¸±à¸¢à¸šà¸´à¸™à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¹à¸•à¹ˆà¸„à¸§à¸²à¸¡à¸ˆà¸¸à¸­à¸²à¸ˆà¸ˆà¸°à¸™à¹‰à¸­à¸¢à¹„à¸›à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢à¸ªà¸³à¸«à¸£à¸±à¸š Peak Season à¹à¸¥à¸°à¸•à¹‰à¸™à¸—à¸¸à¸™à¸•à¹ˆà¸­à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸•à¹ˆà¸³à¸à¸§à¹ˆà¸² A350-900 à¸—à¸³à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆà¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸šà¸´à¸™à¸—à¸µà¹ˆà¸¡à¸µ Demand à¸›à¸²à¸™à¸à¸¥à¸²à¸‡
B787-9,14000,297/36/0,1650,200/20/0,210/25/0,12,"00:05à¸™., 09:30à¸™., 00:05à¸™., 09:30à¸™., 00:05à¸™., 09:30à¸™.","19:00à¸™., 13:00à¸™., 19:00à¸™., 13:00à¸™., 19:00à¸™., 13:00à¸™.",4.0,à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸—à¸µà¹ˆà¸ªà¸¡à¸”à¸¸à¸¥à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸ˆà¸¸à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡ à¹‚à¸”à¸¢à¸¡à¸µà¸•à¹‰à¸™à¸—à¸¸à¸™à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™à¹„à¸”à¹‰à¸à¸±à¸š A350-900 à¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸­à¸‡à¸£à¸±à¸šà¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¹€à¸—à¸µà¹ˆà¸¢à¸§à¸šà¸´à¸™à¸—à¸µà¹ˆà¸ªà¸¹à¸‡à¸‚à¸¶à¹‰à¸™à¹„à¸”à¹‰à¸”à¸µ
B777-300ER,13650,315/40/8,2080,200/20/0,210/25/0,14,"00:05à¸™., 09:30à¸™., 14:00à¸™.","19:00à¸™., 13:00à¸™., 02:00à¸™.",4.2,B777-300ER à¸¡à¸µà¸„à¸§à¸²à¸¡à¸ˆà¸¸à¸ªà¸¹à¸‡à¸¡à¸²à¸ à¹€à¸«à¸¡à¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸š Peak Season à¹à¸•à¹ˆà¸•à¹‰à¸™à¸—à¸¸à¸™à¸ªà¸¹à¸‡. à¸à¸²à¸£à¸¡à¸µ First Class à¸Šà¹ˆà¸§à¸¢à¸•à¸­à¸šà¹‚à¸ˆà¸—à¸¢à¹Œà¸•à¸¥à¸²à¸”à¸žà¸£à¸µà¹€à¸¡à¸µà¸¢à¸¡à¹„à¸”à¹‰à¸”à¸µà¸¡à¸²à¸ à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­à¸‚à¸­à¸‡à¸£à¸¸à¹ˆà¸™à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¸—à¸µà¹ˆà¸¢à¸­à¸¡à¸£à¸±à¸š
"""
        return mock_csv
    else:
        # à¹€à¸žà¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡ Gemini à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡ CSV à¸ˆà¸²à¸ Prompt
        try:
            response = client.models.generate_content(
                model='gemini-2.5-flash',
                contents=prompt
            )
            # à¹ƒà¸™à¸à¸£à¸“à¸µà¸—à¸µà¹ˆ Gemini à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™à¹‚à¸„à¹‰à¸”à¸šà¸¥à¹‡à¸­à¸ Markdown
            if "```csv" in response.text:
                csv_data = response.text.split("```csv")[1].split("```")[0].strip()
            else:
                csv_data = response.text.strip()
            return csv_data
        except APIError as e:
            st.error(f"API_ERROR: à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¹„à¸”à¹‰: {e}")
            return None
        except Exception:
            # Fallback data
            return """A350-900,15000,288/40/0,1950,100/10/0,110/12/0,4,09:30à¸™.,14:00à¸™.,4.0,à¸™à¸µà¹ˆà¸„à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸³à¸¥à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸²à¸˜à¸´à¸•à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™,B787-9,14000,297/36/0,1650,120/15/0,130/18/0,6,00:05à¸™.,19:00à¸™.,4.5,à¸™à¸µà¹ˆà¸„à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸³à¸¥à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸²à¸˜à¸´à¸•à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™"""

# --- 3. à¸ªà¹ˆà¸§à¸™à¸£à¸±à¸š Input (1. à¹€à¸¥à¸·à¸­à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸šà¸´à¸™) ---

client = initialize_gemini()
is_gemini_ready = client is not None and st.session_state.gemini_api_key

if not is_gemini_ready:
    st.warning("ðŸš¨ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆ **Google Gemini API Key** à¹ƒà¸™ Sidebar à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡")

st.header("1. à¹€à¸¥à¸·à¸­à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸šà¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡")
col1, col2, col3 = st.columns(3)

with col1:
    icao_code = st.text_input(
        "**ICAO Code à¸‚à¸­à¸‡à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡**",
        placeholder="à¹€à¸Šà¹ˆà¸™ LHR",
        max_chars=4
    ).upper()

with col2:
    city_name = st.text_input(
        "**à¸Šà¸·à¹ˆà¸­à¹€à¸¡à¸·à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸™à¸²à¸¡à¸šà¸´à¸™à¸•à¸±à¹‰à¸‡à¸­à¸¢à¸¹à¹ˆ (à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©)**",
        placeholder="à¹€à¸Šà¹ˆà¸™ London"
    )

with col3:
    continent = st.selectbox(
        "**à¸—à¸§à¸µà¸›**",
        options=[""] + CONTINENTS
    )

st.session_state.data_consistent = False
st.session_state.distance_km = 0
st.session_state.evaluation_df = None

# à¸›à¸¸à¹ˆà¸¡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡
if st.button("ðŸ”Ž à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™", disabled=not is_gemini_ready or not (icao_code and city_name and continent)):
    if is_gemini_ready:
        with st.spinner("à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸±à¸š Gemini..."):
            consistency_result = check_airport_consistency(client, icao_code, city_name, continent)

        if consistency_result.startswith("PASS"):
            st.success("âœ… à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸™à¸²à¸¡à¸šà¸´à¸™à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡! à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›")
            st.session_state.data_consistent = True
        elif consistency_result.startswith("FAIL"):
            st.session_state.data_consistent = False
            error_message = consistency_result.replace("FAIL:", "").strip()
            st.error(f"âŒ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡: {error_message}")
        elif consistency_result.startswith("API_ERROR"):
            st.session_state.data_consistent = False
            st.error(consistency_result)
        else:
            st.warning(f"âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸µà¸„à¸§à¸²à¸¡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹„à¸”à¹‰: {consistency_result}. à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š API key à¹à¸¥à¸°à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡")
            st.session_state.data_consistent = False


# --- 4. à¸ªà¹ˆà¸§à¸™à¸„à¸³à¸™à¸§à¸“à¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¸œà¸¥à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™ (2. à¹€à¸¥à¸·à¸­à¸à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™) ---

if st.session_state.data_consistent:
    st.header("2. à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸šà¸´à¸™à¹à¸¥à¸°à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™")

    # 2.1 à¸„à¹‰à¸™à¸«à¸²à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™
    if st.session_state.distance_km == 0:
        with st.spinner(f"à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™ BKK à¹„à¸› {icao_code}..."):
            distance = get_flight_distance(client, icao_code)
            st.session_state.distance_km = distance
    else:
        distance = st.session_state.distance_km

    if distance > 0:
        st.info(f"ðŸ“ **à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™ (BKK -> {icao_code}):** **{distance:,} à¸à¸´à¹‚à¸¥à¹€à¸¡à¸•à¸£**")

        # 2.2 & 2.3 à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¹à¸¥à¸°à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥
        if st.session_state.evaluation_df is None:
            with st.spinner("à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸«à¹‰ Gemini à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œ Demand à¹à¸¥à¸°à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸‚à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™..."):
                csv_result = get_aircraft_evaluation(client, distance, icao_code, city_name)
                
            if csv_result and not csv_result.startswith("API_ERROR"):
                try:
                    # à¹à¸›à¸¥à¸‡ CSV à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸ˆà¸²à¸ Gemini à¹€à¸›à¹‡à¸™ DataFrame
                    df = pd.read_csv(io.StringIO(csv_result), header=None)
                    
                    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ 11 à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ (à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™, à¸žà¸´à¸ªà¸±à¸¢, à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡, ... , à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸)
                    if df.shape[1] == 11:
                        df.columns = [
                            "à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™", "à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™ (à¸à¸¡.)", "à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡", 
                            "à¸­à¸±à¸•à¸£à¸²à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡ (USD/hr)", "à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œà¸œà¸¹à¹‰à¹‚à¸”à¸¢à¸ªà¸²à¸£à¸‚à¸²à¹„à¸› (eco/bc/first)", 
                            "à¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œà¸œà¸¹à¹‰à¹‚à¸”à¸¢à¸ªà¸²à¸£à¸‚à¸²à¸à¸¥à¸±à¸š (eco/bc/first)", "à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¹€à¸—à¸µà¹ˆà¸¢à¸§à¸šà¸´à¸™ (à¹„à¸›+à¸à¸¥à¸±à¸š)/à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ", 
                            "à¹€à¸§à¸¥à¸² Departure à¸ˆà¸²à¸ BKK", "à¹€à¸§à¸¥à¸² Departure à¸ˆà¸²à¸à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡", 
                            "à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (à¸”à¸²à¸§)", "à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸"
                        ]
                        st.session_state.evaluation_df = df
                    else:
                        st.error(f"âŒ Gemini à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸¥à¸±à¸šà¸¡à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸šà¸•à¸²à¸¡à¸£à¸¹à¸›à¹à¸šà¸š (à¸„à¸²à¸” 11 à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ à¹„à¸”à¹‰ {df.shape[1]} à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ). à¹‚à¸›à¸£à¸”à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡")
                        st.session_state.evaluation_df = None
                except Exception as e:
                    st.error(f"âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Gemini: {e}")
                    st.session_state.evaluation_df = None
            else:
                 st.error("âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸±à¸šà¸«à¸£à¸·à¸­à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸ˆà¸²à¸ Gemini à¹„à¸”à¹‰")


        if st.session_state.evaluation_df is not None:
            st.subheader("à¸•à¸²à¸£à¸²à¸‡à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™")
            
            # --- à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥à¸”à¸²à¸§ ---
            def format_star(score):
                if score == 0:
                    return "ðŸš« 0 à¸”à¸²à¸§ (à¸šà¸´à¸™à¹„à¸¡à¹ˆà¸–à¸¶à¸‡)"
                # à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸”à¸²à¸§à¹€à¸•à¹‡à¸¡
                full_stars = int(score)
                # à¹€à¸Šà¹‡à¸„à¸„à¸£à¸¶à¹ˆà¸‡à¸”à¸²à¸§
                half_star = "Â½" if score - full_stars >= 0.25 and score - full_stars < 0.75 else ""
                # à¹€à¸Šà¹‡à¸„à¸”à¸²à¸§à¹€à¸•à¹‡à¸¡
                stars = "â˜…" * full_stars
                
                return f"{stars}{half_star} ({score:.1f})"
            
            display_df = st.session_state.evaluation_df.copy()
            display_df['à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (à¸”à¸²à¸§)'] = display_df['à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (à¸”à¸²à¸§)'].astype(float).apply(format_star)
            
            st.dataframe(
                display_df,
                height=300,
                use_container_width=True,
                column_config={
                    "à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸": st.column_config.Column(
                        "à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸",
                        help="à¸ªà¸£à¸¸à¸›à¹€à¸«à¸•à¸¸à¸œà¸¥à¸à¸²à¸£à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡",
                        width="large",
                    ),
                    "à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™ (à¸à¸¡.)": st.column_config.NumberColumn(
                        "à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™ (à¸à¸¡.)",
                        format="%d",
                    ),
                }
            )

            # 2.4 à¸ªà¸£à¹‰à¸²à¸‡ dropdown à¹ƒà¸«à¹‰ user à¹€à¸¥à¸·à¸­à¸
            st.subheader("3. à¹€à¸¥à¸·à¸­à¸à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰")
            aircraft_selection = st.selectbox(
                "**à¹€à¸¥à¸·à¸­à¸à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸™à¸µà¹‰**",
                options=st.session_state.evaluation_df["à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™"].tolist()
            )

            if aircraft_selection:
                selected_data = st.session_state.evaluation_df[
                    st.session_state.evaluation_df["à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸šà¸´à¸™"] == aircraft_selection
                ].iloc[0]

                st.success(f"âœ… à¸„à¸¸à¸“à¹€à¸¥à¸·à¸­à¸à¸£à¸¸à¹ˆà¸™ **{aircraft_selection}** à¹à¸¥à¹‰à¸§!")
                st.markdown(f"""
                * **à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡:** **{selected_data['à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ (à¸”à¸²à¸§)']}**
                * **à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™:** {selected_data['à¸žà¸´à¸ªà¸±à¸¢à¸à¸²à¸£à¸šà¸´à¸™ (à¸à¸¡.)']} à¸à¸¡.
                * **à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¸—à¸µà¹ˆà¹à¸™à¸°à¸™à¸³:** {selected_data['à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¹€à¸—à¸µà¹ˆà¸¢à¸§à¸šà¸´à¸™ (à¹„à¸›+à¸à¸¥à¸±à¸š)/à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ']} à¹€à¸—à¸µà¹ˆà¸¢à¸§à¸šà¸´à¸™à¸•à¹ˆà¸­à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ
                * **à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸:** {selected_data['à¸ªà¸£à¸¸à¸›à¸ªà¸²à¹€à¸«à¸•à¸¸']}
                """)
        else:
            st.warning("âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹à¸ªà¸”à¸‡à¸•à¸²à¸£à¸²à¸‡à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹„à¸”à¹‰à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Gemini.")
    else:
        st.error(f"âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¸šà¸´à¸™à¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸ BKK à¹„à¸› {icao_code} à¹„à¸”à¹‰ à¸«à¸£à¸·à¸­à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¹€à¸›à¹‡à¸™ 0. à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š ICAO Code à¹à¸¥à¸°à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡")
